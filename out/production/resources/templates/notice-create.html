<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>공지 작성</title>

    <!-- (선택) CSRF 사용 시 -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-6 py-3 flex items-center justify-between">
        <a th:href="@{/notices}" class="text-sm px-3 py-1.5 rounded-xl border bg-white hover:bg-slate-100">← 목록</a>
        <span class="text-sm text-slate-500">관리자 전용</span>
    </div>
</header>

<main class="max-w-4xl mx-auto px-6 py-8">
    <section class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
        <h1 class="text-xl font-bold mb-4">공지 작성</h1>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium">제목</label>
                <input id="title" type="text" class="mt-1 w-full rounded-xl border-slate-300" placeholder="제목을 입력하세요" />
            </div>
            <div>
                <label class="block text-sm font-medium">내용</label>
                <textarea id="description" rows="10" class="mt-1 w-full rounded-xl border-slate-300" placeholder="내용을 입력하세요"></textarea>
            </div>

            <div id="status" class="text-sm"></div>

            <div class="flex gap-2">
                <button id="saveBtn" class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700">등록</button>
                <a th:href="@{/notices}" class="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50">취소</a>
            </div>
        </div>
    </section>
</main>

<script>
    function authHeaders(){
        const h = {};
        const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        if (token) h['Authorization'] = `Bearer ${token}`;
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        if (csrfToken && csrfHeader) h[csrfHeader] = csrfToken;
        return h;
    }
    function setStatus(msg, ok=false){
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = 'text-sm ' + (ok ? 'text-emerald-600' : 'text-red-600');
    }

    // ADMIN 가드 (비관리자 접근 차단)
    (async function guardAdmin(){
        try {
            const res = await fetch('/api/users/me', { headers: authHeaders(), credentials: 'include' });
            if (!res.ok) { location.href='/login?error'; return; }
            const me = await res.json();
            const role = (me.role || '').toUpperCase();
            const roles = Array.isArray(me.roles) ? me.roles.map(String) : [];
            const authorities = Array.isArray(me.authorities)
                ? me.authorities.map(a => (a.authority || a).toString())
                : [];
            const isAdmin =
                role === 'ADMIN' || role === 'ROLE_ADMIN' ||
                roles.includes('ADMIN') || roles.includes('ROLE_ADMIN') ||
                authorities.includes('ROLE_ADMIN');
            if (!isAdmin) location.href='/notices';
        } catch { location.href='/login?error'; }
    })();

    document.getElementById('saveBtn').addEventListener('click', async () => {
        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value;

        if (!title) { setStatus('제목을 입력하세요.'); return; }

        try {
            const res = await fetch('/api/notices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...authHeaders() },
                body: JSON.stringify({ title, description })
            });
            if (!res.ok) {
                if (res.status === 403) throw new Error('권한이 없습니다. (관리자 전용)');
                throw new Error('HTTP ' + res.status);
            }
            const data = await res.json(); // { id, title, description }
            setStatus('등록되었습니다.', true);
            location.href = `/notices/${data.id}`;
        } catch (e) {
            setStatus(e.message || '등록 중 오류가 발생했습니다.');
        }
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>로그인</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

    <!-- (선택) CSRF 사용 시 Thymeleaf에서 주입 -->
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
</head>
<body class="min-h-screen bg-slate-50">
<main class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-md bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden">

        <!-- 헤더 -->
        <header class="px-6 py-5 text-white bg-gradient-to-r from-indigo-500 via-sky-500 to-teal-500">
            <h1 class="text-lg font-bold">로그인</h1>
            <p class="text-xs mt-1 opacity-90">아이디와 비밀번호를 입력하세요</p>
        </header>

        <div class="p-6">
            <!-- 상태 메시지 -->
            <div id="statusBox" class="mb-3 text-sm space-y-1" aria-live="polite"></div>

            <!-- 기본 submit은 막고 JS로 JSON 전송 -->
            <form id="loginForm" class="space-y-3" novalidate>
                <!-- 아이디 -->
                <div>
                    <label for="username" class="block text-sm font-semibold">아이디</label>
                    <input id="username"
                           name="username"
                           type="text"
                           autocomplete="username"
                           required
                           class="mt-1 block w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-sky-400"
                           placeholder="아이디" autofocus>
                </div>

                <!-- 비밀번호 + 보기 토글 -->
                <div>
                    <label for="password" class="block text-sm font-semibold">비밀번호</label>
                    <div class="relative">
                        <input id="password"
                               name="password"
                               type="password"
                               autocomplete="current-password"
                               required
                               class="mt-1 block w-full rounded-xl border-slate-300 pr-12 focus:ring-2 focus:ring-sky-400"
                               placeholder="비밀번호"
                               aria-describedby="pw-help">
                        <button type="button"
                                class="absolute inset-y-0 right-0 px-3 text-slate-500 hover:text-slate-700"
                                onclick="togglePw()"
                                aria-label="비밀번호 보기 전환">보기</button>
                    </div>
                    <p id="pw-help" class="sr-only">비밀번호는 8자 이상을 권장합니다.</p>
                </div>

                <div class="flex items-center justify-between pt-1">
                    <label class="inline-flex items-center gap-2 text-sm">
                        <input type="checkbox" id="remember" class="rounded">
                        <span>자동 로그인</span>
                    </label>
                    <a th:href="@{/signup}" class="text-sm text-sky-600 hover:underline">회원가입</a>
                </div>

                <button id="submitBtn" type="submit"
                        class="w-full py-3 rounded-xl font-semibold text-white bg-sky-600 hover:bg-sky-700
                       disabled:opacity-60 disabled:cursor-not-allowed">
          <span class="inline-flex items-center justify-center gap-2">
            <svg id="spinner" class="hidden animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8v4" stroke="currentColor" stroke-width="4"></path>
            </svg>
            <span id="btnText">로그인</span>
          </span>
                </button>
            </form>
        </div>
    </div>
</main>

<script>
    function togglePw() {
        const pw = document.getElementById('password');
        pw.type = pw.type === 'password' ? 'text' : 'password';
    }

    function setLoading(loading) {
        const btn = document.getElementById('submitBtn');
        const spinner = document.getElementById('spinner');
        const text = document.getElementById('btnText');
        btn.disabled = loading;
        spinner.classList.toggle('hidden', !loading);
        text.textContent = loading ? '처리 중...' : '로그인';
    }

    function showStatus(msg, type = 'error') {
        const box = document.getElementById('statusBox');
        const base = 'px-3 py-2 rounded-lg';
        const cls = type === 'success'
            ? 'bg-emerald-50 text-emerald-700 border border-emerald-200'
            : 'bg-red-50 text-red-700 border border-red-200';
        box.innerHTML = `<p class="${base} ${cls}">${msg}</p>`;
    }

    function getCsrfHeader() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        const headerMeta = document.querySelector('meta[name="_csrf_header"]');
        if (!tokenMeta || !headerMeta) return null;
        return { name: headerMeta.content, value: tokenMeta.content };
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);
        showStatus('', 'success'); // reset

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const remember = document.getElementById('remember').checked;

        if (!username || !password) {
            showStatus('아이디와 비밀번호를 입력해 주세요.');
            setLoading(false);
            return;
        }

        // 헤더 구성 (JSON + CSRF)
        const headers = { 'Content-Type': 'application/json' };
        const csrf = getCsrfHeader();
        if (csrf) headers[csrf.name] = csrf.value;

        try {
            const res = await fetch('/api/users/login', {
                method: 'POST',
                headers,
                credentials: 'include', // refresh 쿠키를 받는다면 필요
                body: JSON.stringify({ username, password })
            });

            if (!res.ok) {
                if (res.status === 401) throw new Error('아이디 또는 비밀번호가 올바르지 않습니다.');
                throw new Error('로그인 중 오류가 발생했습니다.');
            }

            const body = await res.json(); // { accessToken: "..." }
            if (!body || !body.accessToken) {
                throw new Error('서버에서 accessToken을 받지 못했습니다.');
            }

            // 자동 로그인 체크 시 localStorage, 아니면 sessionStorage
            const storage = remember ? window.localStorage : window.sessionStorage;
            storage.setItem('accessToken', body.accessToken);

            // 홈으로 이동
            showStatus('로그인 성공! 잠시만 기다려 주세요.', 'success');
            window.location.href = '/';
        } catch (err) {
            showStatus(err.message || '로그인 실패');
        } finally {
            setLoading(false);
        }
    });
</script>
</body>
</html>

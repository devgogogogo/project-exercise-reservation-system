<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>수업 생성</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<header class="sticky top-0 bg-white border-b border-slate-200">
    <div class="max-w-3xl mx-auto px-6 py-3 flex items-center justify-between">
        <a th:href="@{/}" class="text-sm px-3 py-1.5 rounded-xl border bg-white hover:bg-slate-100">← 홈</a>
        <span class="text-sm text-slate-500">수업 생성 (관리자 전용)</span>
    </div>
</header>

<main class="max-w-3xl mx-auto px-6 py-8">
    <section class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
        <h1 class="text-2xl font-bold mb-6">수업 생성</h1>

        <!-- 안내/에러 -->
        <p id="msg" class="hidden mb-4 text-sm"></p>

        <form id="form" class="space-y-6">
            <!-- 수업명 -->
            <div>
                <label for="classname" class="block text-sm font-medium text-slate-700">수업 이름</label>
                <input id="classname" type="text" required
                       class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-400 focus:ring-0"
                       placeholder="예) 요가 초급반"/>
            </div>

            <!-- 설명 -->
            <div>
                <label for="description" class="block text-sm font-medium text-slate-700">설명</label>
                <textarea id="description" rows="4"
                          class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-400 focus:ring-0"
                          placeholder="수업 소개를 적어주세요."></textarea>
            </div>

            <!-- 날짜 선택 -->
            <div>
                <span class="block text-sm font-medium text-slate-700 mb-1">날짜</span>
                <div class="flex gap-3">
                    <div class="flex items-center gap-2">
                        <label for="yearSelect" class="text-sm text-slate-600">연도</label>
                        <select id="yearSelect" class="rounded-lg border-slate-300"></select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="monthSelect" class="text-sm text-slate-600">월</label>
                        <select id="monthSelect" class="rounded-lg border-slate-300">
                            <option value="0">1</option><option value="1">2</option><option value="2">3</option>
                            <option value="3">4</option><option value="4">5</option><option value="5">6</option>
                            <option value="6">7</option><option value="7">8</option><option value="8">9</option>
                            <option value="9">10</option><option value="10">11</option><option value="11">12</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="daySelect" class="text-sm text-slate-600">일</label>
                        <select id="daySelect" class="rounded-lg border-slate-300"></select>
                    </div>
                </div>
            </div>

            <!-- 시간 선택 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="startTime" class="block text-sm font-medium text-slate-700">시작 시간</label>
                    <select id="startTime" class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-400 focus:ring-0"></select>
                </div>
                <div>
                    <label for="endTime" class="block text-sm font-medium text-slate-700">끝나는 시간</label>
                    <select id="endTime" class="mt-1 w-full rounded-xl border-slate-300 focus:border-slate-400 focus:ring-0"></select>
                </div>
            </div>

            <!-- 정원 -->
            <div>
                <label for="capacity" class="block text-sm font-medium text-slate-700">정원</label>
                <input id="capacity" type="number" min="1" step="1" required
                       class="mt-1 w-40 rounded-xl border-slate-300 focus:border-slate-400 focus:ring-0"
                       placeholder="예) 20"/>
            </div>

            <!-- 액션 -->
            <div class="flex items-center justify-end gap-3 pt-2">
                <a href="/classSchedule-calendar" class="px-4 py-2 rounded-xl border bg-white hover:bg-slate-50">취소</a>
                <button id="submitBtn" type="submit"
                        class="px-4 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-50">
                    생성
                </button>
            </div>
        </form>
    </section>
</main>

<script>
    // ===== 관리자 가드 (서버 @PreAuthorize가 최종 보호지만, UX 차원의 보조) =====
    async function guardAdmin() {
        try {
            const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
            const headers = token ? { Authorization: `Bearer ${token}` } : {};
            const res = await fetch('/api/users/me', { headers, credentials: 'include' });
            if (!res.ok) throw 0;
            const me = await res.json();
            const up = s => String(s||'').toUpperCase();
            const role = up(me.role);
            const roles = (me.roles||[]).map(up);
            const auths = (me.authorities||[]).map(a=>up(a.authority||a));
            const isAdmin = role==='ADMIN'||role==='ROLE_ADMIN'||roles.includes('ADMIN')||roles.includes('ROLE_ADMIN')||auths.includes('ROLE_ADMIN');
            if (!isAdmin) location.href = '/login';
        } catch { location.href = '/login'; }
    }
    guardAdmin();

    // ===== 유틸 =====
    const pad = n => String(n).padStart(2,'0');
    function authHeaders() {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        if (token) headers['Authorization'] = `Bearer ${token}`;
        return headers;
    }
    function getParam(name){
        const url = new URL(location.href);
        return url.searchParams.get(name);
    }

    // ===== DOM =====
    const form = document.getElementById('form');
    const msg = document.getElementById('msg');
    const submitBtn = document.getElementById('submitBtn');

    const classnameEl = document.getElementById('classname');
    const descriptionEl = document.getElementById('description');
    const yearEl = document.getElementById('yearSelect');
    const monthEl = document.getElementById('monthSelect');
    const dayEl = document.getElementById('daySelect');
    const startEl = document.getElementById('startTime');
    const endEl = document.getElementById('endTime');
    const capacityEl = document.getElementById('capacity');

    // ===== 초기 데이터 (query ?date=YYYY-MM-DD 있을 수 있음) =====
    const today = new Date();
    let initY = today.getFullYear();
    let initM0 = today.getMonth();
    let initD = today.getDate();

    (function parseQueryDate(){
        const qd = getParam('date'); // 'YYYY-MM-DD'
        if (!qd) return;
        const m = qd.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return;
        initY = Number(m[1]);
        initM0 = Number(m[2]) - 1;
        initD = Number(m[3]);
    })();

    // 연도 select 채우기
    (function fillYears(){
        const start = today.getFullYear() - 5;
        const end = today.getFullYear() + 5;
        for (let y = start; y <= end; y++){
            const opt = document.createElement('option');
            opt.value = y; opt.textContent = y;
            yearEl.appendChild(opt);
        }
    })();

    // 일 select 채우기(월마다 일수 다름)
    function fillDays(y, m0, selectedDay){
        dayEl.innerHTML = '';
        const last = new Date(y, m0+1, 0).getDate();
        for (let d=1; d<=last; d++){
            const opt = document.createElement('option');
            opt.value = d; opt.textContent = d;
            dayEl.appendChild(opt);
        }
        dayEl.value = String(Math.min(selectedDay, last));
    }

    // 시간 옵션(30분 간격, 05:00~23:00)
    function fillTimes(){
        function addOpts(sel){
            sel.innerHTML = '';
            for (let h=5; h<=23; h++){
                for (let m of [0,30]){
                    const v = `${pad(h)}:${pad(m)}`;
                    const opt = document.createElement('option');
                    opt.value = v; opt.textContent = v;
                    sel.appendChild(opt);
                }
            }
        }
        addOpts(startEl); addOpts(endEl);
        startEl.value = '09:00';
        endEl.value = '10:00';
    }

    // 초기값 세팅
    yearEl.value = String(initY);
    monthEl.value = String(initM0);
    fillDays(initY, initM0, initD);
    fillTimes();

    // 월/연 바뀌면 일수 갱신
    yearEl.addEventListener('change', ()=> fillDays(Number(yearEl.value), Number(monthEl.value), Number(dayEl.value||1)));
    monthEl.addEventListener('change', ()=> fillDays(Number(yearEl.value), Number(monthEl.value), Number(dayEl.value||1)));

    // ===== 제출 =====
    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        msg.className = 'hidden'; msg.textContent = '';

        // 간단 검증
        if (!classnameEl.value.trim()){
            msg.className = 'mb-4 text-sm text-red-600'; msg.textContent = '수업 이름을 입력하세요.'; classnameEl.focus(); return;
        }
        if (Number(capacityEl.value) <= 0){
            msg.className = 'mb-4 text-sm text-red-600'; msg.textContent = '정원은 1 이상이어야 합니다.'; capacityEl.focus(); return;
        }
        const start = startEl.value;
        const end = endEl.value;
        if (start >= end){
            msg.className = 'mb-4 text-sm text-red-600'; msg.textContent = '끝나는 시간은 시작 시간보다 늦어야 합니다.'; endEl.focus(); return;
        }

        const y = Number(yearEl.value);
        const m0 = Number(monthEl.value);
        const d = Number(dayEl.value);
        const body = {
            classname: classnameEl.value.trim(),
            description: descriptionEl.value.trim(),
            startTime: start,           // LocalTime: "HH:mm"
            endTime: end,               // LocalTime: "HH:mm"
            date: `${y}-${pad(m0+1)}-${pad(d)}`, // LocalDate: "YYYY-MM-DD"
            capacity: Number(capacityEl.value)
        };

        submitBtn.disabled = true;
        try {
            const res = await fetch('/api/classSchedules', {
                method: 'POST',
                headers: authHeaders(),
                credentials: 'include',
                body: JSON.stringify(body)
            });
            if (!res.ok){
                const text = await res.text().catch(()=> '');
                throw new Error(`생성 실패 (HTTP ${res.status}) ${text&&'- '+text}`);
            }
            const saved = await res.json().catch(()=> null);

            msg.className = 'mb-4 text-sm text-green-600';
            msg.textContent = '수업이 생성되었습니다. 캘린더로 이동합니다…';

            // 생성한 날짜의 월로 돌아가기
            const yyyymm = `${y}-${pad(m0+1)}`;
            setTimeout(()=> location.href = `/classSchedule-calendar?ym=${yyyymm}`, 500);
        } catch (err) {
            msg.className = 'mb-4 text-sm text-red-600';
            msg.textContent = err.message || '오류가 발생했습니다.';
        } finally {
            submitBtn.disabled = false;
        }
    });
</script>
</body>
</html>

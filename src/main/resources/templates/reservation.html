<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ìš´ë™ ì˜ˆì•½ â€“ ClassSchedule</title>

    <!-- CSRF (Spring Security ì‚¬ìš© ì‹œ) -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { brand: { 500:'#5b9cff', 600:'#3e7df0' }, brand2:'#7bd389' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
<header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-brand-500 to-brand2 shadow ring-1 ring-slate-900/20"></div>
            <h1 class="text-base font-semibold">ìš´ë™ ì˜ˆì•½ & ì»¤ë®¤ë‹ˆí‹°</h1>
        </div>
        <nav class="flex gap-2">
            <a th:href="@{/}" class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">í™ˆ</a>
            <a th:href="@{/reservation}" class="px-3 py-1.5 rounded-xl border border-brand-600 bg-brand-600 text-white shadow">ìˆ˜ì—…ì˜ˆì•½</a>
        </nav>
    </div>
</header>

<main class="max-w-7xl mx-auto px-6 pt-8 pb-16">
    <section class="mb-5">
        <h2 class="text-2xl font-bold">ìˆ˜ì—… ì˜ˆì•½</h2>
        <p class="text-slate-500 dark:text-slate-400 mt-1">ì›í•˜ëŠ” ë‚ ì§œì™€ ì¡°ê±´ìœ¼ë¡œ ìˆ˜ì—…ì„ ì°¾ì•„ ì˜ˆì•½í•˜ì„¸ìš”.</p>
    </section>

    <!-- í•„í„° -->
    <section class="bg-white/80 border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm dark:bg-slate-900/60 dark:border-slate-800">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="flex flex-col gap-1.5">
                <label for="date" class="text-xs text-slate-500 dark:text-slate-400">ìˆ˜ì—… ë‚ ì§œ</label>
                <input id="date" type="date" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-900 placeholder-slate-400 outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100" />
            </div>
            <div class="flex flex-col gap-1.5">
                <label for="keyword" class="text-xs text-slate-500 dark:text-slate-400">ê²€ìƒ‰ì–´</label>
                <input id="keyword" type="text" placeholder="í´ë˜ìŠ¤/ê°•ì‚¬/ì¥ì†Œ ê²€ìƒ‰" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-900 placeholder-slate-400 outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100" />
            </div>
            <div class="flex items-end gap-2 sm:col-span-2 lg:col-span-2">
                <button id="resetBtn" class="flex-1 rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">ì´ˆê¸°í™”</button>
                <button id="searchBtn" class="flex-1 rounded-xl border border-brand-600 bg-brand-600 px-3 py-2.5 text-white shadow hover:brightness-110">ì¡°íšŒ</button>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ -->
        <div class="mt-3 flex flex-wrap gap-2 text-sm">
            <button data-quick="today" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ì˜¤ëŠ˜</button>
            <button data-quick="tomorrow" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ë‚´ì¼</button>
            <button data-quick="week" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ì´ë²ˆ ì£¼</button>
        </div>
    </section>

    <!-- ëª©ë¡ -->
    <section id="listWrap" class="mt-5" aria-live="polite">
        <div id="list" class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3"></div>
        <div id="placeholder" class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
        </div>
        <div id="empty" class="hidden text-center text-slate-500 dark:text-slate-400 py-10">ì¡°ê±´ì— ë§ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>
</main>

<script>
    const ENDPOINT = '/api/schedules';
    const BOOK_ENDPOINT = '/api/reservations';

    const pad = n => String(n).padStart(2,'0');
    function fmtTime(iso){
        if(!iso) return '-';
        const d = new Date(iso);
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function authHeaders(){
        const token = localStorage.getItem('accessToken');
        return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    function capacityInfo(item){
        const cap = Number(item.capacity ?? item.maxCapacity ?? 0);
        const enrolled = Number(item.enrolledCount ?? item.currentEnrolled ?? 0);
        const left = Math.max(cap - enrolled, 0);
        const pct = cap > 0 ? Math.min(Math.round((enrolled/cap)*100), 100) : 0;
        return {cap,enrolled,left,pct};
    }

    function card(item){
        const {cap,enrolled,left,pct} = capacityInfo(item);
        const title = item.title || item.name || 'ì´ë¦„ ë¯¸ì •';
        const instructor = item.instructor || item.trainerName || '-';
        const location = item.location || item.room || '-';
        const start = fmtTime(item.startTime || item.startAt);
        const end = fmtTime(item.endTime || item.endAt);

        return `
        <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <h3 class="text-lg font-semibold">${title}</h3>
          <p class="text-sm text-slate-600 dark:text-slate-300">ğŸ•‘ ${start} ~ ${end}</p>
          <p class="text-sm text-slate-600 dark:text-slate-300">ğŸ‘¤ ${instructor}</p>
          <p class="text-sm text-slate-600 dark:text-slate-300">ğŸ“ ${location}</p>
          <div class="mt-2 h-2 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-brand-500 to-brand2" style="width:${pct}%"></div>
          </div>
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">ì •ì› ${cap}ëª… Â· ì‹ ì²­ ${enrolled}ëª… Â· ì”ì—¬ ${left}ëª…</p>
          <div class="mt-3 text-right">
            <button data-id="${item.id}" class="reserve rounded-lg border border-brand-600 bg-brand-600 px-3 py-2 text-sm text-white hover:brightness-110">ì˜ˆì•½</button>
          </div>
        </article>`;
    }

    function renderList(items){
        const list = document.getElementById('list');
        const empty = document.getElementById('empty');
        if(!items || items.length===0){
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        list.innerHTML = items.map(card).join('');
        list.querySelectorAll('.reserve').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                try{
                    const res = await fetch(BOOK_ENDPOINT,{
                        method:'POST',
                        headers:{'Content-Type':'application/json',...authHeaders()},
                        body: JSON.stringify({scheduleId:id})
                    });
                    if(!res.ok) return alert('ì˜ˆì•½ ì‹¤íŒ¨');
                    alert('ì˜ˆì•½ ì™„ë£Œ!');
                    search();
                }catch{ alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
            });
        });
    }

    async function search(){
        const date = document.getElementById('date').value;
        const keyword = document.getElementById('keyword').value.trim();
        const params = new URLSearchParams();
        if(date) params.append('date', date);
        if(keyword) params.append('q', keyword);
        const url = `${ENDPOINT}?${params}`;
        const list = document.getElementById('list');
        list.innerHTML = '<div class="col-span-full text-center py-6 text-slate-400">ë¡œë”© ì¤‘...</div>';
        try{
            const res = await fetch(url,{headers:{Accept:'application/json',...authHeaders()}});
            const data = await res.json();
            const items = Array.isArray(data)?data:(data.content||[]);
            renderList(items);
        }catch(e){
            list.innerHTML = '<div class="col-span-full text-center text-slate-400 py-6">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    document.getElementById('searchBtn').addEventListener('click', search);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
        document.getElementById('date').value='';
        document.getElementById('keyword').value='';
        search();
    });
    document.querySelectorAll('.quick-date').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const d=new Date();
            if(btn.dataset.quick==='today'){}
            else if(btn.dataset.quick==='tomorrow') d.setDate(d.getDate()+1);
            else if(btn.dataset.quick==='week') d.setDate(d.getDate()+7);
            document.getElementById('date').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            search();
        });
    });

    (()=>{
        const d=new Date();
        document.getElementById('date').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        search();
    })();
</script>
</body>
</html>

<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>공지사항</title>

    <!-- (선택) CSRF: 사용 중일 때만 렌더 -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config={theme:{extend:{colors:{brand:{500:'#5b9cff',600:'#3e7df0'}}}}}</script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<!-- 헤더 -->
<header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
        <h1 class="text-base font-semibold">운동 예약 & 커뮤니티</h1>
        <nav class="flex gap-2">
            <a th:href="@{/}" class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white hover:bg-slate-100">홈</a>
            <a th:href="@{/reservation}" class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white hover:bg-slate-100">수업예약</a>
            <a th:href="@{/notices}" class="px-3 py-1.5 rounded-xl border border-brand-600 bg-brand-600 text-white">공지사항</a>
        </nav>
    </div>
</header>

<main class="max-w-7xl mx-auto px-6 pt-8 pb-16">
    <section class="mb-5">
        <h2 class="text-2xl font-bold">공지사항</h2>
        <p class="text-slate-500 mt-1">제목을 클릭하면 상세 내용을 볼 수 있어요.</p>
    </section>

    <!-- 검색바 -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
            <div class="sm:col-span-3">
                <input id="keyword" type="text" placeholder="제목/작성자 검색"
                       class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-600" />
            </div>
            <div class="flex gap-2">
                <button id="resetBtn" class="flex-1 rounded-xl border border-slate-300 bg-white px-3 py-2.5 hover:bg-slate-100">초기화</button>
                <button id="searchBtn" class="flex-1 rounded-xl border border-brand-600 bg-brand-600 px-3 py-2.5 text-white hover:brightness-110">검색</button>
            </div>
        </div>
    </section>

    <!-- 목록 -->
    <section id="listWrap" class="mt-5" aria-live="polite">
        <div id="list" class="divide-y divide-slate-200 bg-white border border-slate-200 rounded-2xl overflow-hidden">
            <!-- JS 렌더 -->
        </div>
        <div id="empty" class="hidden text-center text-slate-500 py-10">등록된 공지가 없습니다.</div>
    </section>
</main>

<script>
    const ENDPOINT = '/api/notices';
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    function authHeaders(){
        const h = {};
        const token = localStorage.getItem('accessToken');
        if(token) h['Authorization'] = `Bearer ${token}`;
        if(csrfToken && csrfHeader) h[csrfHeader] = csrfToken;
        return h;
    }

    function row(item){
        const title = item.title || '(제목 없음)';
        const createdAt = item.createdAt || item.created_at || '';
        const author = item.author || item.writer || '관리자';
        return `
        <a href="/notices/${item.id}" class="block px-4 py-4 hover:bg-slate-50">
          <div class="flex items-center gap-2">
            <h3 class="font-medium">${title}</h3>
            ${item.pinned ? '<span class="text-xs rounded border px-1.5 py-0.5">고정</span>' : ''}
          </div>
          <div class="mt-1 text-xs text-slate-500">작성자 ${author} · ${createdAt}</div>
        </a>
      `;
    }

    function renderList(items){
        const list = document.getElementById('list');
        const empty = document.getElementById('empty');
        if(!items || items.length === 0){
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        list.innerHTML = items.map(row).join('');
    }

    async function search(){
        const kw = document.getElementById('keyword').value.trim();
        const params = new URLSearchParams();
        if(kw) params.append('q', kw);
        // 나중에 page/size 붙이기 쉬움
        const url = params.toString() ? `${ENDPOINT}?${params}` : ENDPOINT;

        const list = document.getElementById('list');
        list.innerHTML = Array.from({length:6})
            .map(()=>`<div class="px-4 py-4 animate-pulse text-slate-400">로딩 중…</div>`).join('');
        try{
            const res = await fetch(url, { headers: { 'Accept':'application/json', ...authHeaders() }});
            if(!res.ok) throw new Error('HTTP '+res.status);
            const data = await res.json();
            const items = Array.isArray(data) ? data : (data.content || data.items || []);
            renderList(items);
        }catch(e){
            list.innerHTML = `<div class="px-4 py-6 text-center text-slate-500">목록을 가져오지 못했습니다. (${e.message})</div>`;
        }
    }

    document.getElementById('searchBtn').addEventListener('click', search);
    document.getElementById('resetBtn').addEventListener('click', ()=>{ document.getElementById('keyword').value=''; search(); });

    (function init(){ search(); })();
</script>
</body>
</html>

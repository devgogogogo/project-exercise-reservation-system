<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>예약 관리</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <style>
        .day-scroll { max-height: 12rem; overflow: auto; }
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
        .btn-icon { font-size:.9rem }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<header class="sticky top-0 bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <a th:href="@{/}" class="text-sm px-3 py-1.5 rounded-xl border bg-white hover:bg-slate-100">← 홈</a>
        <span class="text-sm text-slate-500">예약 관리 (관리자 전용)</span>
    </div>
</header>

<main class="max-w-8xl mx-auto px-6 py-8">
    <section class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
        <div class="flex flex-wrap items-center gap-4 mb-6">
            <h1 class="text-xl font-bold">예약 관리</h1>

            <div class="flex items-center gap-2 ml-auto">
                <button id="prevMonth" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">〈</button>
                <button id="nextMonth" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">〉</button>
            </div>

            <div class="flex items-center gap-2">
                <label for="yearSelect" class="text-sm text-slate-600">연도</label>
                <select id="yearSelect" class="rounded-lg border-slate-300"></select>
                <label for="monthSelect" class="text-sm text-slate-600">월</label>
                <select id="monthSelect" class="rounded-lg border-slate-300">
                    <option value="0">1</option><option value="1">2</option><option value="2">3</option>
                    <option value="3">4</option><option value="4">5</option><option value="5">6</option>
                    <option value="6">7</option><option value="7">8</option><option value="8">9</option>
                    <option value="9">10</option><option value="10">11</option><option value="11">12</option>
                </select>
            </div>

            <button id="goToday" class="px-3 py-1.5 rounded-lg border hover:bg-slate-50">오늘로</button>
        </div>

        <!-- 요일 헤더 -->
        <div class="grid grid-cols-7 text-center text-sm font-semibold text-slate-600 mb-3">
            <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
        </div>

        <!-- 달력 -->
        <div id="calendar" class="grid grid-cols-7 gap-5"></div>
    </section>
</main>

<!-- 삭제 확인 모달 -->
<div id="confirmModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-[28rem] text-center">
        <p class="font-semibold mb-2">해당 수업을 삭제할까요?</p>
        <p id="confirmTarget" class="text-sm text-slate-500 mb-6"></p>
        <div class="flex justify-center gap-4">
            <button id="confirmYes" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">삭제</button>
            <button id="confirmNo" class="px-4 py-2 rounded-lg border bg-white hover:bg-slate-100">취소</button>
        </div>
    </div>
</div>

<script>
    /* ===== 설정 ===== */
    const LIST_ENDPOINT  = '/api/classSchedules/calendar';   // ?start=YYYY-MM-DD&end=YYYY-MM-DD
    const DELETE_BY_ID   = '/api/classSchedules/';           // + {id}
    const CREATE_FORM    = '/classSchedule-createForm';
    const UPDATE_FORM    = '/classSchedule-updateForm';      // + ?id=&ym=

    /* ===== 관리자 가드(보조) ===== */
    async function guardAdmin() {
        try {
            const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
            const headers = token ? { Authorization: `Bearer ${token}` } : {};
            const res = await fetch('/api/users/me', { headers, credentials: 'include' });
            if (!res.ok) throw 0;
            const me = await res.json();
            const up = s => String(s||'').toUpperCase();
            const role  = up(me.role);
            const roles = (me.roles||[]).map(up);
            const auths = (me.authorities||[]).map(a=>up(a.authority||a));
            const isAdmin = role==='ADMIN'||roles.includes('ADMIN')||roles.includes('ROLE_ADMIN')||auths.includes('ROLE_ADMIN');
            if (!isAdmin) location.href = '/login';
        } catch { location.href = '/login'; }
    }
    guardAdmin();

    /* ===== 유틸 ===== */
    const pad = n => String(n).padStart(2, '0');
    const yyyyMmDd = (y,m0,d) => `${y}-${pad(m0+1)}-${pad(d)}`;
    function authHeaders(){
        const headers = { 'Content-Type':'application/json' };
        const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        if (token) headers['Authorization'] = `Bearer ${token}`;
        return headers;
    }

    /* ===== 상태 ===== */
    const calendarEl = document.getElementById('calendar');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect= document.getElementById('monthSelect');
    const prevBtn    = document.getElementById('prevMonth');
    const nextBtn    = document.getElementById('nextMonth');
    const goTodayBtn = document.getElementById('goToday');

    const today = new Date();
    let viewYear  = today.getFullYear();
    let viewMonth = today.getMonth(); // 0..11
    let scheduleMap = {}; // {'YYYY-MM-DD': [ {id, className, ...}, ... ]}

    (function fillYears(){
        const start = today.getFullYear()-5, end=today.getFullYear()+5;
        for(let y=start; y<=end; y++){
            const o=document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o);
        }
    })();

    /* ===== 데이터 ===== */
    async function loadMonthSchedules(y,m0){
        const start = yyyyMmDd(y,m0,1);
        const end   = yyyyMmDd(y,m0, new Date(y,m0+1,0).getDate());
        const url = `${LIST_ENDPOINT}?start=${start}&end=${end}`;
        try{
            const res = await fetch(url, { headers:{ Accept:'application/json', ...authHeaders() } });
            if(!res.ok) throw 0;
            const data  = await res.json();
            const items = Array.isArray(data) ? data : (data.content || []);
            scheduleMap = {};
            for(const it of items){
                const dayKey = (typeof it.date==='string') ? it.date : null;
                if(!dayKey) continue;
                (scheduleMap[dayKey] ||= []).push(it);
            }
        }catch{ scheduleMap={}; }
    }

    /* ===== 렌더 ===== */
    function renderCalendar(){
        yearSelect.value = String(viewYear);
        monthSelect.value= String(viewMonth);
        calendarEl.innerHTML='';

        const first = new Date(viewYear, viewMonth, 1);
        const last  = new Date(viewYear, viewMonth+1, 0);
        const firstWeekday = first.getDay();
        const daysInMonth  = last.getDate();

        for(let i=0;i<firstWeekday;i++){ const b=document.createElement('div'); b.className='h-44 rounded-2xl'; calendarEl.appendChild(b); }

        for(let d=1; d<=daysInMonth; d++){
            const dateStr = yyyyMmDd(viewYear, viewMonth, d);
            const isToday = dateStr === yyyyMmDd(today.getFullYear(), today.getMonth(), today.getDate());

            const box = document.createElement('div');
            box.className = 'border rounded-2xl p-3 flex flex-col items-stretch justify-start h-44 text-left';
            box.dataset.date = dateStr;

            const head = document.createElement('div');
            head.className='flex items-center justify-between mb-2';
            head.innerHTML = `
        <span class="font-semibold ${isToday?'text-sky-600':''}">${d}</span>
        <button class="addBtn text-green-600 text-xl leading-none" title="수업 생성">＋</button>
      `;
            box.appendChild(head);

            const listWrap = document.createElement('div');
            listWrap.className='day-scroll no-scrollbar space-y-1';
            const items = scheduleMap[dateStr] || [];

            if(items.length===0){
                const empty = document.createElement('div');
                empty.className='text-sm text-slate-400';
                empty.textContent='등록된 수업 없음';
                listWrap.appendChild(empty);
            }else{
                const maxShow = 8;
                items.slice(0,maxShow).forEach(it=>{
                    const id    = it.id ?? it.classSchedulesId ?? it.classScheduleId ?? it.scheduleId;
                    const title = it.className ?? it.classname ?? it.title ?? '(제목 없음)';

                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2 text-[0.95rem] px-2 py-1.5 rounded-lg bg-slate-100 text-slate-800';
                    row.innerHTML = `
            <span class="flex-1 min-w-0 whitespace-nowrap overflow-hidden text-ellipsis" title="${title}">
              ${title}
            </span>
            <div class="ml-auto flex gap-2 shrink-0">
              <button class="editBtn btn-icon px-2 py-0.5 rounded border hover:bg-white" data-id="${id}" title="수정">수정</button>
              <button class="delBtn  btn-icon px-2 py-0.5 rounded border hover:bg-white text-red-600"
                      data-id="${id}" data-title="${title}" data-date="${dateStr}" title="삭제">삭제</button>
            </div>
          `;
                    listWrap.appendChild(row);
                });
                if(items.length>maxShow){
                    const more=document.createElement('div'); more.className='text-xs text-slate-500';
                    more.textContent=`+ ${items.length-maxShow}개 더 있음`; listWrap.appendChild(more);
                }
            }

            box.appendChild(listWrap);
            calendarEl.appendChild(box);
        }

        const totalCells = firstWeekday+daysInMonth;
        const tailBlanks = (7-(totalCells%7))%7;
        for(let i=0;i<tailBlanks;i++){ const b=document.createElement('div'); b.className='h-44 rounded-2xl'; calendarEl.appendChild(b); }
    }

    /* ===== 삭제 모달 ===== */
    const modal = document.getElementById('confirmModal');
    const confirmTarget = document.getElementById('confirmTarget');
    let targetId = null;

    document.getElementById('confirmNo').addEventListener('click', ()=>{
        modal.classList.add('hidden'); targetId=null;
    });
    document.getElementById('confirmYes').addEventListener('click', async ()=>{
        if(!targetId) return;
        try{
            const res = await fetch(DELETE_BY_ID + targetId, { method:'DELETE', headers:authHeaders() });
            if(!res.ok) throw new Error('삭제 실패 (HTTP '+res.status+')');
            modal.classList.add('hidden'); targetId=null;
            await loadMonthSchedules(viewYear, viewMonth);
            renderCalendar();
        }catch(err){
            alert('삭제 중 오류: ' + (err.message||'알 수 없는 오류'));
            modal.classList.add('hidden'); targetId=null;
        }
    });

    /* ===== 이벤트 위임 ===== */
    calendarEl.addEventListener('click', (e)=>{
        const addBtn = e.target.closest('.addBtn');
        if(addBtn){
            const box = addBtn.closest('[data-date]'); if(!box) return;
            const date = box.dataset.date;
            location.href = `${CREATE_FORM}?date=${date}`;
            return;
        }

        const editBtn = e.target.closest('.editBtn');
        if(editBtn){
            const id = editBtn.dataset.id;
            if(!id){ alert('수정할 수업 ID를 찾지 못했습니다.'); return; }
            const ym = `${viewYear}-${pad(viewMonth+1)}`;
            location.href = `${UPDATE_FORM}?id=${id}&ym=${ym}`;
            return;
        }

        const delBtn = e.target.closest('.delBtn');
        if(delBtn){
            targetId = delBtn.dataset.id;
            const title = delBtn.dataset.title || '';
            const date  = delBtn.dataset.date || '';
            confirmTarget.textContent = `[${date}] ${title}`;
            modal.classList.remove('hidden');
            return;
        }
    });

    /* ===== 네비/셀렉트 ===== */
    async function redrawMonth(){ await loadMonthSchedules(viewYear, viewMonth); renderCalendar(); }
    prevBtn.addEventListener('click', async()=>{ if(viewMonth===0){viewYear--; viewMonth=11;} else viewMonth--; await redrawMonth(); });
    nextBtn.addEventListener('click', async()=>{ if(viewMonth===11){viewYear++; viewMonth=0;} else viewMonth++; await redrawMonth(); });
    goTodayBtn.addEventListener('click', async()=>{ viewYear=today.getFullYear(); viewMonth=today.getMonth(); await redrawMonth(); });
    yearSelect.addEventListener('change', async()=>{ viewYear=Number(yearSelect.value); await redrawMonth(); });
    monthSelect.addEventListener('change', async()=>{ viewMonth=Number(monthSelect.value); await redrawMonth(); });

    /* ===== 초기 로드 ===== */
    (async function init(){
        const ym = new URL(location.href).searchParams.get('ym');
        if(ym && /^(\d{4})-(\d{2})$/.test(ym)){ const [y,m]=ym.split('-').map(Number); viewYear=y; viewMonth=m-1; }
        yearSelect.value=String(viewYear); monthSelect.value=String(viewMonth);
        await loadMonthSchedules(viewYear, viewMonth);
        renderCalendar();
    })();
</script>
</body>
</html>

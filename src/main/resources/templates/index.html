<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>CrossFit Box — 홈</title>

    <!-- Tailwind (개발용 CDN) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        // 필요하면 커스터마이즈 가능
        tailwind.config = {
            theme: { extend: {} }
        }
    </script>

    <!-- 가로 스크롤바 숨김 유틸 -->
    <style>
        :root{
            --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
            --primary:#0ea5e9; --primary-dark:#0284c7; --danger:#ef4444; --ring:#3ea1d5;
            --border:#e2e8f0;
        }
        body{
            background: linear-gradient(135deg, #f8fafc, var(--bg));
            color: var(--text);
        }
        .no-scrollbar::-webkit-scrollbar{display:none;}
        .no-scrollbar{-ms-overflow-style:none; scrollbar-width:none;}
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-900
             bg-gradient-to-b from-sky-50 to-indigo-50">

<!-- HEADER -->
<header class="border-b border-slate-200 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
        <!-- 홈 링크는 루트로 -->
        <a th:href="@{/}" class="font-extrabold tracking-tight text-xl">CrossFit Box</a>
        <nav class="flex items-center gap-4">
            <a th:href="@{/login}" class="text-sm font-medium hover:text-sky-700">로그인</a>
            <a th:href="@{/signup}" class="text-sm font-medium hover:underline">회원가입</a>
        </nav>
    </div>

    <nav class="border-t border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- ▼ 수정: 좌측 메뉴 + 우측 환영 문구를 같은 행에 배치 -->
            <div class="flex items-center justify-between py-3">
                <ul class="flex gap-6 overflow-x-auto no-scrollbar text-sm font-semibold">
                    <li><a th:href="@{/notices}"  class="hover:text-sky-700">크로스핏 이란?</a></li>
                    <li><a th:href="@{/booking}"  class="hover:text-sky-700">코치 소개</a></li>
                    <li><a th:href="@{/program}"  class="hover:text-sky-700">문의 사항</a></li>
                    <li><a th:href="@{/my}"       class="hover:text-sky-700">오시는 길</a></li>
                </ul>
                <!-- 우측 환영 문구 자리 -->
                <div id="welcome-box" class="text-sm font-semibold text-slate-700 hidden">
                    <span id="welcome-text"></span>
                </div>
            </div>
        </div>
    </nav>
</header>

<!-- BODY -->
<main class="flex-1">
    <!-- 가운데 히어로 이미지 -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="bg-gradient-to-r from-indigo-500 via-sky-500 to-cyan-500 p-[1px] rounded-2xl shadow-lg">
            <div class="rounded-[14px] overflow-hidden">
                <img
                        src="https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=2000&auto=format&fit=crop"
                        alt="크로스핏 히어로"
                        class="w-full h-[500px] md:h-[600px] object-cover"
                />
            </div>
        </div>
    </section>

    <!-- 공지사항 & 오늘의 운동 카드(같은 틀) -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-6 grid gap-6 md:grid-cols-2">
        <!-- 공지사항 -->
        <div class="bg-white rounded-2xl shadow p-6 border border-slate-100
              relative before:content-[''] before:absolute before:inset-x-0 before:top-0
              before:h-1 before:bg-gradient-to-r before:from-sky-400 before:to-indigo-400">
            <h3 class="text-lg font-extrabold mb-4">공지 사항</h3>
            <ul class="divide-y">
                <li class="py-3 flex items-center justify-between" th:each="n : ${notices}">
                    <a th:href="@{'/notices/' + ${n.id}}" class="truncate hover:underline" th:text="${n.title}">10월
                        공지사항</a>
                    <span class="text-sm text-gray-400 shrink-0 ml-4"
                          th:text="${#temporals.format(n.date, 'yyyy.MM.dd')}">2025.09.29</span>
                </li>
                <li class="py-3 flex items-center justify-between" th:if="${#lists.isEmpty(notices)}">
                    <span class="text-gray-500">등록된 공지가 없습니다.</span>
                </li>
            </ul>
            <div class="mt-4 text-right">
                <a th:href="@{/notices}" class="text-sm font-semibold text-sky-700 hover:underline">전체 보기</a>
            </div>
        </div>

        <!-- 오늘의 운동 -->
        <div class="bg-white rounded-2xl shadow p-6 border border-slate-100
              relative before:content-[''] before:absolute before:inset-x-0 before:top-0
              before:h-1 before:bg-gradient-to-r before:from-sky-400 before:to-indigo-400">
            <h3 class="text-lg font-extrabold mb-4">오늘의 운동 (WOD)</h3>
            <ul class="divide-y">
                <li class="py-3 flex items-center justify-between" th:each="w : ${wods}">
                    <a th:href="@{'/wod/' + ${w.id}}" class="truncate hover:underline" th:text="${w.title}">
                        Strength: Back Squat 5×5 / Metcon: 12’ AMRAP
                    </a>
                    <span class="text-sm text-gray-400 shrink-0 ml-4"
                          th:text="${#temporals.format(w.date, 'yyyy.MM.dd')}">2025.09.29</span>
                </li>
                <li class="py-3 flex items-center justify-between" th:if="${#lists.isEmpty(wods)}">
                    <span class="text-gray-500">등록된 WOD가 없습니다.</span>
                </li>
            </ul>
            <div class="mt-4 text-right">
                <a th:href="@{/wod}" class="text-sm font-semibold text-sky-700 hover:underline">전체 보기</a>
            </div>
        </div>
    </section>

    <!-- 네모 메뉴 4개 -->
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a th:href="@{/notices}" class="block rounded-2xl border shadow-sm hover:shadow-md transition
                                 hover:ring-2 hover:ring-sky-200">
                <div class="flex flex-col items-center justify-center p-6 min-h-[120px]">
                    <div class="w-12 h-12 rounded-xl border flex items-center justify-center mb-3">📢</div>
                    <span class="font-bold">공지사항</span>
                </div>
            </a>
            <a th:href="@{/reservation}"  class="block rounded-2xl border shadow-sm hover:shadow-md transition
                                 hover:ring-2 hover:ring-sky-200">
                <div class="flex flex-col items-center justify-center p-6 min-h-[120px]">
                    <div class="w-12 h-12 rounded-xl border flex items-center justify-center mb-3">🗓️</div>
                    <span class="font-bold">수업 예약</span>
                </div>
            </a>
            <a th:href="@{/my}" class="block rounded-2xl border shadow-sm hover:shadow-md transition
                                 hover:ring-2 hover:ring-sky-200">
                <div class="flex flex-col items-center justify-center p-6 min-h-[120px]">
                    <div class="w-12 h-12 rounded-xl border flex items-center justify-center mb-3">👤</div>
                    <span class="font-bold">내 정보</span>
                </div>
            </a>
            <a th:href="@{/program}" class="block rounded-2xl border shadow-sm hover:shadow-md transition
                                 hover:ring-2 hover:ring-sky-200">
                <div class="flex flex-col items-center justify-center p-6 min-h-[120px]">
                    <div class="w-12 h-12 rounded-xl border flex items-center justify-center mb-3">🏋️</div>
                    <span class="font-bold">프로그램</span>
                </div>
            </a>
        </div>
    </section>
</main>

<!-- FOOTER -->
<footer class="mt-auto border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-sm text-gray-500">
        © <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}"></span> CrossFit Box. All rights reserved.
    </div>
</footer>

<!-- ▼ 로그인 상태 환영 문구 스크립트 -->
<script>
    (function () {
        const welcomeBox  = document.getElementById('welcome-box');
        const welcomeText = document.getElementById('welcome-text');

        // 저장 위치/키는 프로젝트에 맞게 조정하세요.
        let accessToken = localStorage.getItem('accessToken');

        // 사용자 정보 조회 함수
        async function fetchMe() {
            if (!accessToken) throw new Error('NO_ACCESS');
            const res = await fetch('/api/users/me', {
                headers: { Authorization: `Bearer ${accessToken}` },
                credentials: 'include' // refresh 쿠키 전략을 쓸 때 재발급 호출에 필요
            });
            if (res.status === 401) throw new Error('EXPIRED');
            if (!res.ok) throw new Error('ME_FAIL');
            return res.json();
        }

        // access 만료 시 refresh로 재발급
        async function tryRefresh() {
            const res = await fetch('/api/users/refresh', {
                method: 'POST',
                credentials: 'include' // refresh를 쿠키로 갖고 있으면 자동 전송
            });
            if (!res.ok) throw new Error('REFRESH_FAIL');
            const body = await res.json();
            // 서버가 { accessToken: "..." } 으로 내려준다고 가정
            accessToken = body.accessToken;
            localStorage.setItem('accessToken', accessToken);
        }

        (async function run() {
            try {
                const me = await fetchMe();
                welcomeText.textContent = `${me.name}님 어서오세요`;
                welcomeBox.classList.remove('hidden');
            } catch (e) {
                if (e.message === 'EXPIRED') {
                    try {
                        await tryRefresh();
                        const me = await fetchMe();
                        welcomeText.textContent = `${me.name}님 어서오세요`;
                        welcomeBox.classList.remove('hidden');
                    } catch {
                        // 재발급 실패하면 로그인 문구 숨김 유지
                        welcomeBox.classList.add('hidden');
                    }
                } else {
                    welcomeBox.classList.add('hidden');
                }
            }
        })();
    })();
</script>

</body>
</html>

<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ìš´ë™ ì˜ˆì•½ â€“ ClassSchedule</title>

    <!-- CSRF (Spring Security ì‚¬ìš© ì‹œ) -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { brand: { 500:'#5b9cff', 600:'#3e7df0' }, brand2:'#7bd389' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
<header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-900/80 backdrop-blur border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-brand-500 to-brand2 shadow ring-1 ring-slate-900/20"></div>
            <h1 class="text-base font-semibold">ìš´ë™ ì˜ˆì•½ & ì»¤ë®¤ë‹ˆí‹°</h1>
        </div>
        <nav class="flex gap-2">
            <a th:href="@{/}" class="px-3 py-1.5 rounded-xl border border-slate-300 bg-white text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">í™ˆ</a>
            <a th:href="@{/reservation}" class="px-3 py-1.5 rounded-xl border border-brand-600 bg-brand-600 text-white shadow">ìˆ˜ì—…ì˜ˆì•½</a>
        </nav>
    </div>
</header>

<main class="max-w-7xl mx-auto px-6 pt-8 pb-16">
    <section class="mb-5">
        <h2 class="text-2xl font-bold">ìˆ˜ì—… ì˜ˆì•½ ëª©ë¡</h2>
        <p class="text-slate-500 dark:text-slate-400 mt-1">ì›í•˜ëŠ” ë‚ ì§œì™€ ì¡°ê±´ìœ¼ë¡œ ìˆ˜ì—…ì„ ì°¾ì•„ ì˜ˆì•½í•˜ì„¸ìš”.</p>
    </section>

    <!-- í•„í„° -->
    <section class="bg-white/80 border border-slate-200 rounded-2xl p-4 md:p-5 shadow-sm dark:bg-slate-900/60 dark:border-slate-800">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="flex flex-col gap-1.5">
                <label for="date" class="text-xs text-slate-500 dark:text-slate-400">ìˆ˜ì—… ë‚ ì§œ</label>
                <input id="date" type="date" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-900 placeholder-slate-400 outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100" />
            </div>
            <div class="flex flex-col gap-1.5">
                <label for="keyword" class="text-xs text-slate-500 dark:text-slate-400">ê²€ìƒ‰ì–´</label>
                <input id="keyword" type="text" placeholder="í´ë˜ìŠ¤/ê°•ì‚¬/ì¥ì†Œ ê²€ìƒ‰" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-900 placeholder-slate-400 outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100" />
            </div>
            <div class="flex items-end gap-2 sm:col-span-2 lg:col-span-2">
                <button id="resetBtn" class="flex-1 rounded-xl border border-slate-300 bg-white px-3 py-2.5 text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">ì´ˆê¸°í™”</button>
                <button id="searchBtn" class="flex-1 rounded-xl border border-brand-600 bg-brand-600 px-3 py-2.5 text-white shadow hover:brightness-110">ì¡°íšŒ</button>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ -->
        <div class="mt-3 flex flex-wrap gap-2 text-sm">
            <button data-quick="today" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ì˜¤ëŠ˜</button>
            <button data-quick="tomorrow" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ë‚´ì¼</button>
            <button data-quick="week" class="quick-date px-3 py-1.5 rounded-full border border-slate-300 bg-white hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800">ì´ë²ˆ ì£¼</button>
        </div>
    </section>

    <!-- ëª©ë¡ -->
    <section id="listWrap" class="mt-5" aria-live="polite">
        <div id="list" class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3"></div>
        <div id="placeholder" class="mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
            <div class="rounded-2xl border border-dashed border-slate-300 bg-white/50 p-6 text-center text-slate-400 dark:border-slate-700 dark:bg-slate-800/40">ë¹ˆ í´ë˜ìŠ¤ ì¹´ë“œ</div>
        </div>
        <div id="empty" class="hidden text-center text-slate-500 dark:text-slate-400 py-10">ì¡°ê±´ì— ë§ëŠ” ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </section>
</main>

<script>
    // ====== ì—”ë“œí¬ì¸íŠ¸(í•„ìš” ì‹œ ê²½ë¡œ ë§ì¶° ë³€ê²½) ======
    const ENDPOINT = '/api/schedules';         // ëª©ë¡ ì¡°íšŒ
    const BOOK_ENDPOINT = '/api/reservations'; // ì˜ˆì•½ ìƒì„±

    // ====== ìœ í‹¸ ======
    const pad = n => String(n).padStart(2,'0');

    function fmtDateTime(iso){
        if(!iso) return '-';
        const d = new Date(iso);
        if (isNaN(d.getTime())) return '-';
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function authHeaders(){
        const token = localStorage.getItem('accessToken') || sessionStorage.getItem('accessToken');
        return token ? { 'Authorization': `Bearer ${token}` } : {};
    }

    // ì •ì›/ì‹ ì²­ ì¸ì› ê³„ì‚° (ë°±ì—”ë“œì—ì„œ ì–´ë–¤ í‚¤ë¡œ ì¤„ì§€ ëª°ë¼ì„œ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬)
    function capacityInfo(item){
        const cap = Number(item.capacity ?? item.maxCapacity ?? 0);
        const enrolled = Number(item.enrolledCount ?? item.currentEnrolled ?? item.reservedCount ?? 0);
        const left = Math.max(cap - enrolled, 0);
        const pct = cap > 0 ? Math.min(Math.round((enrolled/cap)*100), 100) : 0;
        return {cap,enrolled,left,pct, full: cap > 0 && left <= 0};
    }

    // ì‹œì‘ ì‹œê° ì¶”ì¶œ (ê°€ëŠ¥í•œ ì—¬ëŸ¬ í‚¤ ì§€ì›)
    function extractStartISO(item){
        // 1) í†µí•© í•„ë“œ ìš°ì„ 
        if (item.startAt || item.startDateTime) return item.startAt || item.startDateTime;
        // 2) date + time ì¡°í•©
        if (item.date && item.startTime) {
            // startTime ì´ "HH:mm" ì´ê±°ë‚˜ "HH:mm:ss" ë¼ê³  ê°€ì •
            const time = String(item.startTime);
            return `${item.date}T${time.length===5? time+":00" : time}`;
        }
        // 3) ë‹¨ì¼ timeë§Œ ìˆìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ (fallback)
        if (item.startTime) {
            const now = new Date();
            const y = now.getFullYear(), m = pad(now.getMonth()+1), d = pad(now.getDate());
            const time = String(item.startTime);
            return `${y}-${m}-${d}T${time.length===5? time+":00" : time}`;
        }
        return null;
    }

    // 20ë¶„ ì´ì „ê¹Œì§€ë§Œ ì˜ˆì•½ ê°€ëŠ¥
    function isBookableByTime(startIso){
        if (!startIso) return false;
        const start = new Date(startIso);
        if (isNaN(start.getTime())) return false;
        const now = new Date();
        const diffMin = Math.floor((start - now)/60000);
        return diffMin > 20; // ì‹œì‘ 20ë¶„ ì „ê¹Œì§€ ê°€ëŠ¥
    }

    function card(item){
        // ì œëª©(ìˆ˜ì—…ì´ë¦„)
        const title = item.classname || item.className || item.title || item.name || 'ì´ë¦„ ë¯¸ì •';

        // ì‹œì‘/ì¢…ë£Œ í‘œì‹œìš© (í‘œì‹œë§Œ; ì˜ˆì•½ ê°€ëŠ¥ íŒë‹¨ì€ startë§Œ í•„ìš”)
        const startIso = extractStartISO(item);
        const endIso   = item.endAt || item.endDateTime || (item.date && item.endTime ? `${item.date}T${String(item.endTime).length===5 ? item.endTime+":00" : item.endTime}` : null);
        const startDisp = fmtDateTime(startIso);
        const endDisp   = fmtDateTime(endIso);

        // ì •ì›/ì‹ ì²­ ìˆ˜
        const {cap,enrolled,left,pct,full} = capacityInfo(item);

        // ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€(ì‹œê°„)
        const timeOk = isBookableByTime(startIso);

        // ë²„íŠ¼ ìƒíƒœ ê²°ì •
        let btnHtml = '';
        if (full) {
            // ì •ì› ê½‰ ì°¸ â†’ 'ì¸ì›ë§Œì„' (ë¹„í™œì„±, ë‹¤ë¥¸ ìƒ‰)
            btnHtml = `<button class="cursor-not-allowed rounded-lg border px-3 py-2 text-sm
                           border-slate-300 bg-slate-200 text-slate-500
                           dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400"
                         disabled>ì¸ì›ë§Œì„</button>`;
        } else if (!timeOk) {
            // ì‹œê°„ ì œí•œ ì§€ë‚˜ê° â†’ 'ì˜ˆì•½ë§ˆê°' (ë¹„í™œì„±)
            btnHtml = `<button class="cursor-not-allowed rounded-lg border px-3 py-2 text-sm
                           border-slate-300 bg-slate-200 text-slate-500
                           dark:border-slate-700 dark:bg-slate-800 dark:text-slate-400"
                         disabled>ì˜ˆì•½ë§ˆê°</button>`;
        } else {
            // ì˜ˆì•½ ê°€ëŠ¥
            btnHtml = `<button data-id="${item.id}" class="reserve rounded-lg border border-emerald-600 bg-emerald-600 px-3 py-2 text-sm text-white hover:brightness-110">ìˆ˜ì—…ê°€ëŠ¥</button>`;
        }

        return `
      <article class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
        <h3 class="text-lg font-semibold">${title}</h3>
        <p class="text-sm text-slate-600 dark:text-slate-300">ğŸ•‘ ${startDisp} ~ ${endDisp}</p>
        <!-- í•„ìš” ì‹œ ê°•ì‚¬/ì¥ì†Œ ë§¤í•‘: item.instructor / item.location -->
        <div class="mt-2 h-2 rounded-full bg-slate-100 dark:bg-slate-800 overflow-hidden">
          <div class="h-full bg-gradient-to-r from-brand-500 to-brand2" style="width:${pct}%"></div>
        </div>
        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
          ì •ì› ${cap || 0}ëª… Â· ì‹ ì²­ ${enrolled || 0}ëª… Â· ì”ì—¬ ${left || 0}ëª…
        </p>
        <div class="mt-3 text-right">
          ${btnHtml}
        </div>
      </article>`;
    }

    function renderList(items){
        const list = document.getElementById('list');
        const empty = document.getElementById('empty');
        document.getElementById('placeholder').classList.add('hidden');

        if(!items || items.length===0){
            list.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');
        list.innerHTML = items.map(card).join('');

        // ì˜ˆì•½ ê°€ëŠ¥í•œ ë²„íŠ¼ë§Œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        list.querySelectorAll('.reserve').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
                const id = btn.getAttribute('data-id');
                try{
                    const res = await fetch(BOOK_ENDPOINT,{
                        method:'POST',
                        headers:{'Content-Type':'application/json',...authHeaders()},
                        body: JSON.stringify({ scheduleId:id })
                    });
                    if(!res.ok){
                        const t = await res.text().catch(()=> '');
                        return alert(t || 'ì˜ˆì•½ ì‹¤íŒ¨');
                    }
                    alert('ì˜ˆì•½ ì™„ë£Œ!');
                    search(); // ìƒˆë¡œê³ ì¹¨ ëŒ€ì²´: ì”ì—¬ ì¸ì› UI ê°±ì‹ 
                }catch{
                    alert('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                }
            });
        });
    }

    async function search(){
        const date = document.getElementById('date').value;
        const keyword = document.getElementById('keyword').value.trim();
        const params = new URLSearchParams();
        if(date) params.append('date', date);
        if(keyword) params.append('q', keyword);
        const url = `${ENDPOINT}?${params.toString()}`;

        const list = document.getElementById('list');
        document.getElementById('placeholder').classList.remove('hidden');
        list.innerHTML = '';

        try{
            const res = await fetch(url,{headers:{Accept:'application/json',...authHeaders()}});
            const data = await res.json();
            const items = Array.isArray(data) ? data : (data.content || []);
            renderList(items);
        }catch(e){
            document.getElementById('placeholder').classList.add('hidden');
            list.innerHTML = '<div class="col-span-full text-center text-slate-400 py-6">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì´ë²¤íŠ¸
    document.getElementById('searchBtn').addEventListener('click', search);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
        document.getElementById('date').value='';
        document.getElementById('keyword').value='';
        search();
    });
    document.querySelectorAll('.quick-date').forEach(btn=>{
        btn.addEventListener('click',()=>{
            const d=new Date();
            if(btn.dataset.quick==='today'){}
            else if(btn.dataset.quick==='tomorrow') d.setDate(d.getDate()+1);
            else if(btn.dataset.quick==='week') d.setDate(d.getDate()+7);
            document.getElementById('date').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            search();
        });
    });

    // ì´ˆê¸° ì¡°íšŒ(ì˜¤ëŠ˜)
    (()=>{
        const d=new Date();
        document.getElementById('date').value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
        search();
    })();
</script>
</body>
</html>

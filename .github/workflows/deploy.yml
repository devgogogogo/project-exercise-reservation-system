name: CD - Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ”¹ SSH í‚¤ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ì¤„ë°”ê¿ˆ ë¬¸ì œ ë°©ì§€)
      - name: Write SSH key to file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # ğŸ”¹ (ì˜µì…˜) GHCRì´ privateì´ë©´ ë¡œê·¸ì¸ í•„ìš” â€” publicì´ë©´ ì´ ë¸”ë¡ì€ ìƒëµí•´ë„ ë¨
      # - name: Login to GHCR (optional)
      #   run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      # ğŸ”¹ EC2 ì ‘ì†í•´ì„œ ìë™ ë°°í¬ ì‹¤í–‰
      - name: Connect and Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}     # ubuntu
          key_path: key.pem                     # âœ… key ëŒ€ì‹  key_path ì‚¬ìš©
          port: 22
          script: |
            set -eux
            cd ~/app
            echo "[1/3] Pulling latest image..."
            docker compose pull
            echo "[2/3] Rebuilding and restarting containers..."
            docker compose up -d
            echo "[3/3] Checking container status..."
            docker compose ps

name: CD - Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ”¹ 1ï¸âƒ£ SSH í‚¤ë¥¼ íŒŒì¼ë¡œ ì €ìž¥ (ì¤„ë°”ê¿ˆ ë¬¸ì œ ë°©ì§€)
      - name: Write SSH key to file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # ðŸ”¹ 2ï¸âƒ£ (ì˜µì…˜) GHCRì´ privateì´ë©´ ë¡œê·¸ì¸ â€” publicì´ë©´ ìƒëžµí•´ë„ ë¨
      # - name: Login to GHCR (optional)
      #   run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      # ðŸ”¹ 3ï¸âƒ£ ë ˆí¬ì˜ docker-compose.yml íŒŒì¼ì„ EC2ë¡œ ì—…ë¡œë“œ
      - name: Upload docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~/app"

      # ðŸ”¹ 4ï¸âƒ£ GitHub Secrets ê°’ìœ¼ë¡œ .env íŒŒì¼ì„ EC2ì— ìž‘ì„±
      - name: Write .env on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -eux
            cat > ~/app/.env << 'EOF'
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            SPRING_DATA_REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}
            SPRING_DATA_REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}
            JWT_KEY=${{ secrets.JWT_KEY }}
            EOF

      # ðŸ”¹ 5ï¸âƒ£ EC2ì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull & up -d (ì‹¤ì œ ë°°í¬)
      - name: Connect and Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: key.pem
          port: 22
          script: |
            set -eux
            cd ~/app
            echo "[1/3] Pulling latest image..."
            docker compose pull
            echo "[2/3] Rebuilding and restarting containers..."
            docker compose up -d
            echo "[3/3] Checking container status..."
            docker compose ps

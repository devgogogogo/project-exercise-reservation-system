name: CD - Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 0) ë ˆí¬ íŒŒì¼ ì²´í¬ì•„ì›ƒ (í•„ìˆ˜!)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) SSH í‚¤ íŒŒì¼ ì €ìž¥
      - name: Write SSH key to file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # 2) ì›ê²© ê²½ë¡œ ì¤€ë¹„ (~/app ì—†ìœ¼ë©´ ìƒì„±)
      - name: Ensure remote deploy directory
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -eux
            mkdir -p ~/app

      # 3) docker-compose.yml ì—…ë¡œë“œ
      - name: Upload docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~/app"
          overwrite: true

      # 4) Secretsë¡œ .env ìž‘ì„±
      - name: Write .env on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -eux
            cat > ~/app/.env << 'EOF'
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            SPRING_DATA_REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}
            SPRING_DATA_REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}
            SPRING_DATA_REDIS_PASSWORD=${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
            JWT_KEY=${{ secrets.JWT_KEY }}
            EOF

      # 5) (ì˜µì…˜) GHCR privateì´ë©´ ë¡œê·¸ì¸
      # - name: Login to GHCR (optional for private images)
      #   run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      # 6) ë°°í¬ ì‹¤í–‰
      - name: Connect and Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          envs: JWT_KEY=${{ secrets.JWT_KEY }}  # ðŸ‘ˆ ì¶”ê°€ëœ ë¶€ë¶„
          script: |
            set -eux
            cd ~/app
            echo "[1/3] Pulling latest image..."
            docker compose pull
            echo "[2/3] Rebuilding and restarting containers..."
            docker compose up -d
            echo "[3/3] Checking container status..."
            docker compose ps

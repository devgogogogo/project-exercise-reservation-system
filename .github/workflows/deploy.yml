name: CD - Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 0) 레포 파일 체크아웃 (필수!)
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) SSH 키 파일 저장
      - name: Write SSH key to file
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      # 2) 원격 경로 준비 (~/app 없으면 생성)
      - name: Ensure remote deploy directory
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -eux
            mkdir -p ~/app

      # 3) 프로젝트 전체 업로드 (Dockerfile + 소스 포함)
      - name: Upload project to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: |
            .
          target: "~/app"
          overwrite: true
          rm: true

      # 4) Secrets로 .env 작성
      - name: Write .env on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -eux
            cat > ~/app/.env << 'EOF'
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            SPRING_DATA_REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}
            SPRING_DATA_REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}
            SPRING_DATA_REDIS_PASSWORD=${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
            JWT_KEY=${{ secrets.JWT_KEY }}

            MYSQL_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            MYSQL_USER=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            MYSQL_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            REDIS_HOST=${{ secrets.SPRING_DATA_REDIS_HOST }}
            REDIS_PORT=${{ secrets.SPRING_DATA_REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.SPRING_DATA_REDIS_PASSWORD }}
            EOF

      # 5) 배포 실행 (빌드 + 실행)
      - name: Connect and Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -eux
            cd ~/app
            echo "[1/3] Pulling dependencies (if any)..."
            docker compose pull || true
            echo "[2/3] Building and starting containers..."
            docker compose up -d --build
            echo "[3/3] Checking container status..."
            docker compose ps
